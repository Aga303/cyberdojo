
<script language="javascript" type="text/javascript">

editAreaLoader.init(
  {
     id: "tabbed_files"	
    ,allow_toggle: false
    ,is_editable: <%=@editable-%>
    ,language: "en"
    ,start_highlight: true
    ,syntax: "<%=@manifest[:language]-%>"	
    ,toolbar: "search, go_to_line, undo, redo, select_font, reset_highlight, help"
    ,is_multi_files: false
    ,EA_load_callback: "editAreaLoaded"
    ,EA_file_close_callback: "editAreaFileClose"
    ,show_line_colors: true
    ,font_size: <%=@manifest[:font_size]-%>
    ,font_family: "<%=@manifest[:font_family]-%>"
    ,replace_tab_by_spaces: <%=@manifest[:tab_size]-%>
    }
);

function editAreaLoaded(id)
{
  <% @manifest[:visible_files].each do |filename,info| -%>
     <% if info.include? :preloaded and info[:preloaded] -%>
       editAreaTabbedLoad("<%=filename-%>");
     <%- end -%>
  <% end -%>
}

var closing_old_run_tests_output = false
var current_file_name = false

function editAreaFileClose(closing)
{
  var id = closing['id']
  if (!closing_old_run_tests_output)
  {
    $(id).value = editAreaLoader.getFile('tabbed_files', id).text;
  }
  current_file_name = false;
  return true; 
}

function editAreaTabbedLoad(name)
{
  if (current_file_name) {
      editAreaLoader.closeFile('tabbed_files', current_file_name);
  }
  editAreaLoader.openFile(
    'tabbed_files',
    { id: name, text: $(name).value, title: name });
  current_file_name = name;
}

function preRunTests()
{
   Element.show('run_tests_spinner');

   var names = editAreaLoader.getAllFiles('tabbed_files');
   for(var name in names)
   { 
     // Move contents of editArea tabs still open into hidden textareas.
     // Necessary because only individual textareas have unique
     // id's which rails can retrieve via params[id]
     var text = editAreaLoader.getFile('tabbed_files', name).text;      
     $(name).value = text
   }; 
}

function postRunTests()
{
   Element.hide('run_tests_spinner');
}

function predict(prediction)
{
   $('run_tests_prediction').value = prediction;
}

function newFile()
{
  var filename = $('new-filename').value;
  filename = filename.split(' ').join('');
  if (filename=="") return;

  // We're about to put a new tab into editArea for the given filename.
  // This new tab will be referenced by editAreaFileClose() and
  // preRunTests() which both assume there will be dom element of the given 
  // filename. So first, add the dom element for the filename.
  var ta = document.createElement("textarea");
  ta.setAttribute('id', filename);
  ta.setAttribute('name', filename);
  $('visible_files_container').appendChild(ta);

  // Make the new filename visible in the file-manager list
  var mle = document.createElement("div");
  mle.setAttribute('id', filename + "-button");
  mle.setAttribute('class', 'fake-button box');
  mle.onclick = new Function("editAreaTabbedLoad('" + filename + "')");
  mle.appendChild(document.createTextNode(filename));
  $('filename-button-list').appendChild(mle);

  // make its name available to rails
  var current = $('visible_filenames_container').value;
  current += filename;
  current += ";";
  $('visible_filenames_container').value = current;

  // Blank out the new-filename text input
  $('new-filename').value = '';

  // Now add the tab to editArea
  editAreaLoader.openFile(
    'tabbed_files',
    { id: filename, text: "", title: filename });
}
</script>

