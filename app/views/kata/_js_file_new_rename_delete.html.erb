
<script language="javascript" 
        type="text/javascript">

function rebuildFileList()
{
  filenames = allFilenames();
  filenames.sort(function(lhs,rhs) {
	if (lhs < rhs)
	  return -1;
	else if (lhs > rhs)
	  return 1;
	else
	  return 0; // Should never happen
  });

  var filename_list = $('filename_list');
  // Remove all children
  while (filename_list.childNodes.length >= 1)
  {
     filename_list.removeChild(filename_list.firstChild);
  } 

  // Add new children
  for (at = 0; at != filenames.length; at++)
  {
    filename_list.appendChild(makeFileListEntry(filenames[at]));
  }
}

//====================== NEW FILE =======================

function newFile()
{
  // Append three random chars to the end of the untitled filename.
  // This is so there is NO excuse not to rename it!
  newFileContent('untitled_' + random3(), '', 0);
}

function newFileContent(filename, content, caret_pos)
{
  // Create new hidden input elements to store new file content
  // and its caret position (to save to before submitting form)
  $('visible_files_container').appendChild(createFileContentInput(filename, content));
  rebuildFileList();
  $('visible_files_container').appendChild(createFileCaretPosInput(filename, caret_pos));

  // Select it so you can immediately rename it
  loadFile(filename);
}

//====================== DELETE FILE =======================

function deleteFile()
{
  deleteFilePrompt(true);
}

function deleteFilePrompt(ask)
{
  var filename = current_filename;
  if (filename == 'kata.sh')
  {
    alert("CyberDojo cannot delete kata.sh because\n" +
          "that is the file the CyberDojo server runs.");
    return; // Cancelled
  }
  if (ask && !confirm("Delete " + filename)) { return; /* Cancelled */ }

  // OK. Now do it...
  var fc = fileContent(filename);
  fc.parentNode.removeChild(fc);
  rebuildFileList();
  
  var fcp = fileCaretPos(filename);
  fcp.parentNode.removeChild(fcp);

  // Reload kata.sh which is always available as it cannot be renamed or deleted
  // NB: Important to set current_filename to false because loadFile()
  //     does an auto saveCurrentFile() which would look into DOM nodes that
  //     have just been deleted.
  current_filename = false;
  loadFile('kata.sh');
  refreshLineNumbering();
}

//====================== RENAME FILE =======================

function renameFile()
{
  var filename = current_filename;
  if (filename == 'kata.sh')
  {
    alert("CyberDojo cannot rename kata.sh because\n" +
          "that is the file the CyberDojo server runs.");
    return; // Cancelled
  }

  var newname = trim(prompt("Rename " + filename + " ?", filename));
  if (newname == null) return; // Cancelled
  if (newname == "") { alert("No filename entered\n" +
                             "Rename " + filename + " abandoned"); return; }
  if (newname == filename) { /* Same name; nothing to do. */ return; }
  if (fileAlreadyExists(newname))
  {
    alert("CyberDojo cannot rename " + filename + " to " + newname + "\n" +
          "because a file called " + newname + " already exists.");
    return; // Cancelled
  }

  // OK. Now do it...
  // Rename by deleting and recreating with previous content
  var content = $('editor').value;
  var caret_pos = getLiveCaretPos();
  deleteFilePrompt(false);
  newFileContent(newname, content, caret_pos);

  rebuildFileList();
  refreshLineNumbering();
  selectFileInFileList(newname);
}


function refreshLineNumbering()
{
  // Ensure line-numbers repositions by removing and re-adding
  // (renaming a file can alter the file-list panel width)
  var old = $('line_numbers');
  old.parentNode.removeChild(old);
  createTextAreaWithLineNumbers('editor', "<%=@kata.tab-%>");
  TabEntry.enable('editor');
}


function createFileContentInput(filename, content)
{
  var input = new Element('input');
  input.setAttribute('type', 'hidden');
  input.setAttribute('name', "file_content['" + filename + "']");
  input.setAttribute('id', "file_content['" + filename + "']");
  input.setAttribute('value', content);
  return input;
}


function createFileCaretPosInput(filename, caret_pos)
{
  var input = new Element('input');
  input.setAttribute('type', 'hidden');
  input.setAttribute('name', "file_caret_pos['" + filename + "']");
  input.setAttribute('id', "file_caret_pos['" + filename + "']");
  input.setAttribute('value', caret_pos);
  return input;
}


function trim(stringToTrim) 
{
  return stringToTrim.replace(/^\s+|\s+$/g,"");
}


function makeFileListEntry(filename)
{
  var div = new Element('div', { class:'filename' });
  div.onclick = function() { loadFile(filename); };
  var inp = new Element('input', 
    { id:'radio_' + filename, 
      name:'filename', 
      type:'radio', 
      value:filename 
    });
  div.appendChild(inp);
  div.appendChild(document.createTextNode(filename));

  var td = new Element("td");
  td.appendChild(div);
  var tr = new Element("tr");
  tr.appendChild(td);

  return tr;
}

function allFilenames()
{
  filenames = []
  var all = $$('input[id^="file_content["]');
  for(at = 0; at != all.length; at++)
  {
    var att = all[at].getAttribute('id');
    var prefix = 'file_content['.length + 1; // +1 for '
    var filename = att.substr(prefix, att.length - prefix - 1 - 1); // -1 for ', -1 for ]
    filenames.push(filename);
  }
  return filenames;
}

function fileAlreadyExists(filename)
{
  return allFilenames().indexOf(filename) != -1;
}

function random3() 
{
    var alphabet = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZ';
    var str = '';
    for (var at = 0; at != 3; at++) 
    {
        var pos = Math.floor(Math.random() * alphabet.length);
        str += alphabet.charAt(pos);
    }
    return str;
}

</script>

