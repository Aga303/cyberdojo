
<div id="traffic_lights" class="panel">
  <table>
  
    <% index = 0 -%>
    
    <% seconds_per_td = 20 -%>
    <% max_seconds_uncollapsed = 30 * 60 -%>
    <% gapper = TdGapper.new(@dojo.created, seconds_per_td, max_seconds_uncollapsed) -%>
    <% gapper.fully_gapped(@dojo.all_increments, make_time(Time.now)).each do |avatar_name,td_map| -%>
      <% parity = (index % 2 == 0) ? "even" : "odd" -%>
      <% index += 1 -%>
      <tr class="<%=parity-%> traffic_light_row">
      
        <td>
          <%= avatar_image(avatar_name, 45) -%>
        </td>
        
        <td>
          <% avatar = Avatar.new(@dojo, avatar_name) -%> 
          <% kata = avatar.kata -%>
          <% if @languages.length != 1 -%> <span class="small_title"><%= kata.language -%></span> <% end -%> 
          <% if @katas.length != 1 -%> <span class="small_title"><%= kata.name -%></span> <% end -%>      
        </td>
        
        <% max_tds_displayed = 90 -%>
        <% all_td_nos = td_map.keys.sort -%>
        <% recent_td_nos = recent(all_td_nos, max_tds_displayed) -%>
        
        <% if recent_td_nos.length < all_td_nos.length -%>
          <td>
          ...
          </td>
        <% end -%>
        
        <% recent_td_nos.each do |td_no| -%>
          <% lights = td_map[td_no] -%>            
          <td>
          <% if lights.class == Array -%>
            <% if lights.length == 0 -%>
              &nbsp;
            <% else -%>
              <table>
                <tr>
                  <% lights.each do |light| -%>
                  <%=  traffic_light(@dojo.name, avatar_name, light) -%>     
                  <% end -%>
                </tr>
              </table>
            <% end -%>
          <% end -%>
          
          <% if lights.class == Hash -%>
             ... <% # lights[:collapsed] -%>
          <% end -%>          
          </td>          
        <% end -%>
        
      </tr>    
    <% end -%>
  
  </table>
</div>

